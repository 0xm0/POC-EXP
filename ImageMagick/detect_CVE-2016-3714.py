import os
import os.path
import sys
import re
import platform
"""使用说明：
将detect_CVE-2016-3714.py放置需要检测的目录之中，命令行运行"python detect_CVE-2016-3714.py",结果将显示该目录下可能存在ImageTragick漏洞的文件。

(检测文件会持续更新...)   
"""                     
if len(sys.argv) == 2:
    rootdir = sys.argv[1]
else:
	rootdir = os.getcwd()

sep = '/'
if "Windows" in platform.system():
	sep ='\\' 

def detect():
	for parent,dirnames,filenames in os.walk(rootdir):
		for filename in filenames:
			#print filename
			try:
				f = open(parent + sep + filename, "r")
			except Exception,e:
				continue
			else:
				str = f.readline().lower()
				while str:
					if re.search( r"(image|url).+https://.+[;\"]\s*\|\s*", str, re.I):
						if filename != sys.argv[0]:
							print "maybe vuln file : ", parent+sep+filename
						break
					str = f.readline()
				f.close()
if __name__ == '__main__':
    detect()